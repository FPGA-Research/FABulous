name: Build and Push Docker Image

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_IMAGE: ghcr.io/fpga-research/fabulous

jobs:
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          # Remove unnecessary tools and libraries
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/lib/jvm
          sudo rm -rf /usr/share/swift

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: nixbuild/nix-quick-install-action@v34
        with:
          nix_version: "2.31.2"
          nix_conf: |
            substituters = https://cache.nixos.org https://nix-cache.fossi-foundation.org
            extra-trusted-public-keys = nix-cache.fossi-foundation.org:3+K59iFwXqKsL7BNu6Guy0v+uTlwsxYQxjspXzqLYQs=

      - name: Build Docker images with Nix
        run: |
          # Build release image (non-editable, for end users)
          nix build -f nix/docker-image.nix release -o docker-image-release
          # Build dev image (editable, for developers)
          nix build -f nix/docker-image.nix dev -o docker-image-dev

      - name: Clean Nix store before loading images
        run: |
          nix store gc

      - name: Load Docker images
        run: |
          docker load < docker-image-release
          docker load < docker-image-dev

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: fpga-research
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Docker tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Tag and push Docker images
        run: |
          # Push release image with version tags
          for tag in ${{ steps.meta.outputs.tags }}; do
            echo "Tagging fabulous:latest as $tag"
            docker tag "fabulous:latest" "$tag"
            echo "Pushing $tag"
            docker push "$tag"
          done

          # Push dev image with dev tag
          echo "Pushing dev image..."
          docker tag "fabulous:dev" "${{ env.DOCKER_IMAGE }}:dev"
          docker push "${{ env.DOCKER_IMAGE }}:dev"

      - name: Test Docker images
        run: |
          echo "Testing release image..."
          docker run --rm "fabulous:latest" FABulous --version
          echo "Testing dev image..."
          docker run --rm "fabulous:dev" bash -c "echo 'Dev image OK'"
